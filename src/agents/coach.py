import os
from langchain_core.messages import HumanMessage, SystemMessage
from dotenv import find_dotenv, load_dotenv
from langchain_openai import ChatOpenAI
from pydantic import SecretStr

from src.agents.board_members import BaseBoardMember
from src.agents.prompts.coach_prompts import COACH_SYSTEM_PROMPT
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser

class Coach(BaseBoardMember):
    """
    æ•™ç»ƒï¼šçœ‹é—®é¢˜ã€äº‹å®ä»¥åŠæˆ˜ç•¥å®˜çš„è§‚ç‚¹ï¼Œåæ‰‹å‘è¨€ã€‚
    """
    def __init__(self):
        super().__init__("Coach", COACH_SYSTEM_PROMPT)
        # æ³¨æ„ï¼šæ•™ç»ƒçš„è¾“å…¥å¤šäº†ä¸€ä¸ª 'strategist_opinion'
        self.prompt = ChatPromptTemplate.from_messages([
            ("system", self.system_prompt),
            ("user", "User Query: {query}\n\n[Fact Context]:\n{context}\n\n[User Profile] (Generated by Mem0):{user_profile}\n]n[Strategist's Opinion]:\n{strategist_opinion}")
        ])
        self.chain = self.prompt | self.llm | StrOutputParser()

    def opine(self, query: str, context: str, strategist_opinion: str, user_profile: str) -> str:
        """
        å‘è¡¨åé©³ (Antithesis)
        """
        print(f"ğŸ§˜ [æ•™ç»ƒ] æ­£åœ¨è¯„ä¼°å¿ƒç†å¥åº·é£é™©...")
        return self.chain.invoke({
            "query": query,
            "user_profile": user_profile,
            "context": context,
            "strategist_opinion": strategist_opinion
        })